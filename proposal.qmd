---
title: "**Variance All the Way Down:** Quantifying the Uncertainty Introduced at each Stage of an End-to-End RNA-Seq Analysis"
author: "Art Tay"
format:
  pdf:
     documentclass: article
     papersize: letter
     geometry:
         margin=1in
     include-in-header: header.tex
bibliography: references.bib
csl: american-statistical-association.csl
---

```{r setup, include=FALSE}
##Setup code
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# Libraries
library(tidyverse)
library(tidymodels)
library(kableExtra)


#tidymodels_prefer()
```

# Abstract 

In the realm of RNA-Seq research, rigorous data preprocessing is a critical foundation for meaningful analysis. Despite its importance, this preprocessing involves numerous stages, each introducing potential sources of variance. While previous studies have examined the overall variance across entire RNA-Seq pipelines, [@arora2020variability] [@tong2020impact], [@vieth2019systematic], the impact of individual stages remains less understood. We propose a comprehensive investigation into the variance introduced at each stage of RNA-Seq preprocessing. Our goal is to quantify these variances, study their distributions, and understand their statistical implications on downstream modeling. This will include exploring the multitude of decisions researchers face — from quality control to normalization and feature selection — and evaluating how these choices propagate uncertainty through the analysis. Of particular interest is whether variance amplifies due to interactions between decisions made at different stages. By modeling these interactions, we aim to identify cases where suboptimal combinations of preprocessing choices exacerbate variability, potentially distorting biological interpretations. Finally, we will assess various bias correction methods and uncertainty quantification strategies to incorporate into final models. This work aims to provide researchers with actionable insights and robust statistical tools to mitigate preprocessing-induced variance, ultimately enhancing the reliability and reproducibility of RNA-Seq studies.

# Preliminary Results

## Preliminary Methodology Section 

```{r}
#| echo: false
#| align: center
table_1 <- data.frame(
    steps = c("1. Pull SRA data from the NIH.",
              "", 
              "2. Compute quality scores.", "", 
              "", 
              "3. Filter low quality reads.", "", 
              "", 
              "4. Trim excess bases.", "", 
              "",
              "5. Align reads to a genome.", "", 
              "",
              "6. Count genes.", "", "",
              "", 
              "7. Count normalization.", 
              "", 
              "8. Differential expression analysis."),  
    software = c("prefetch", 
                 "", 
                 "fasterq-dump", "", 
                 "", 
                 "fastp", "", 
                 "", 
                 "fastp", "", 
                 "", 
                 "Various", "", 
                 "", 
                 "featureCounts", "", "", 
                 "", 
                 "edgeR", 
                 "",
                 "edgeR"), 
    options = c("NA", 
                "", 
                "--skip-technical", "--threads X", 
                "", 
                "--qualified_quality_phred X", "--length_required X", 
                "", 
                "--trim_poly_g", "--trim_ploy_x", 
                "", 
                "Default", "", 
                "", 
                "-Q (minimum map quality.)", "-C (require pair agreement.)", 
                    "-M (allow multi-map.)",
                "", 
                "calcNormFactors(method='X')", 
                "", 
                "Default"), 
    type = c("NA", 
             "", 
             "Boolean", "Integer", 
             "", 
             "Integer", "Integer", 
             "", 
             "Boolean", "Boolean", 
             "", 
             "STAR, HISAT2", "Salmon, Kallisto", 
             "", 
             "Integer", "Boolean", "Boolean", 
             "", 
             "TMM, RLE, upperquartile",
             "", 
             "NA")
)     

colnames(table_1) <- c("Pipeline Steps", "Software", "Options", "Choices")

table_1 |> kbl(format = "latex", booktabs = T,
     longtable = T, linesep = "", 
     caption = "Basic RNA-Seq Differential Analysis End-to-End Pipeline")
```

## Quality Score Variance Due to Fasterq-dump Options 

```{r}
#| echo: true
#| eval: false
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("ShortRead")
BiocManager::install("Rsubread")
```

```{r}
#| echo: true
#| eval: false
library(ShortRead)

sample_1_fq_1 <- readFastq("./data/dump_1/SRR31476642.fastq") 
sample_1_fq_2 <- readFastq("./data/dump_2/SRR31476642.fastq")
sample_1_fq_3 <- readFastq("./data/dump_3/SRR31476642.fastq")
```

```{r}
#| echo: true
#| eval: false
sample_1_fq_1_qual <- as(quality(sample_1_fq_1), "matrix")
sample_1_fq_2_qual <- as(quality(sample_1_fq_2), "matrix")
sample_1_fq_3_qual <- as(quality(sample_1_fq_3), "matrix")

sample_1_fq_13_qual_diff <- sample_1_fq_1_qual - sample_1_fq_3_qual
sample_1_fq_12_qual_diff <- sample_1_fq_1_qual - sample_1_fq_2_qual
```

```{r}
#| echo: true
#| eval: false
mean(sample_1_fq_13_qual_diff)
mean(sample_1_fq_12_qual_diff)
```

## Comparing Alignment Accuracy  

```{r}
#| echo: true
#| eval: false
fastq_files <- list.files(
    path = "./data/dump_1", pattern = "\\.fastq$", full.names = TRUE
)
```

```{r}
#| echo: true
#| eval: false
library(Rsubread)

buildindex(basename="hg19_g1k",
           reference="./data/human_g1k_v37.fasta",
           memory=3600
)

align_reads <- function(file, index_base, output_dir) {
  align(
    index = index_base,
    readfile1 = file,
    output_file = file.path(output_dir, paste0(basename(file), ".bam")),
    nthreads = 4
  )
}
```

```{r}
#| echo: true
#| eval: false
trim_reads <- function(file, quality_threshold = 20, min_length = 30) {
    fq <- readFastq(file)
    fq_filtered <- fq[
        alphabetScore(quality(fq)) >= quality_threshold & width(fq) >= min_length
    ]
    output_file <- sub(".fastq", "_trimmed.fastq", file)
    writeFastq(fq_filtered, output_file, compress = FALSE)
}
```